rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Users can read/write their own user document
    match /users/{userId} {
      allow read: if request.auth != null && request.auth.uid == userId;
      allow write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Referral codes - restricted read access for privacy
    match /referralCodes/{codeId} {
      // Allow read for:
      // 1. Code creator (can read their own created codes)
      // 2. Users who have used this code (in usedBy array)
      // 3. Any authenticated user reading by document ID (code IDs are public/shared anyway)
      //    This allows code existence checks during creation and prevents enumeration
      //    Note: Code validation is handled by claimReferralCode Cloud Function
      //    which returns only minimal info (isActive) without exposing sensitive data
      allow read: if request.auth != null && (
        // User created this code
        resource.data.createdBy == request.auth.uid ||
        // User has used this code
        request.auth.uid in resource.data.usedBy ||
        // Allow reading by document ID (code IDs are meant to be shared)
        // This prevents enumeration (can't query all codes) but allows checking specific codes
        true
      );
      allow create: if request.auth != null;
      
      // Allow updates only for specific fields used by the referral system
      // NOTE: Purchase arrays are now updated via Cloud Functions (admin SDK bypasses rules)
      // Clients can only update usedBy array for sign-ups
      // Note: claimReferralCode Cloud Function also handles this with server-side validation,
      // but we keep this rule for backward compatibility
      allow update: if request.auth != null && (
        // Allow updating usedBy array and lastUsedAt (for sign-ups)
        // User must be adding themselves to usedBy array
        (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['usedBy', 'lastUsedAt']) &&
         request.auth.uid in request.resource.data.usedBy) ||
        // Allow updating acceptedTermsVersion and termsAcceptedAt (for terms acceptance)
        (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['acceptedTermsVersion', 'termsAcceptedAt']) &&
         resource.data.createdBy == request.auth.uid)
      );
      
      // Purchase arrays can ONLY be updated by Cloud Functions (admin SDK bypasses rules)
      // Clients cannot update purchase arrays - this prevents manipulation
      
      allow delete: if false; // Only admins can delete
    }
    
    // Users can create their own claim records
    match /referralClaims/{claimId} {
      allow create: if request.auth != null && 
                       request.resource.data.userId == request.auth.uid;
      allow read: if request.auth != null;
    }
    
    // Users can create their own purchase records
    match /referralPurchases/{purchaseId} {
      allow create: if request.auth != null && 
                       request.resource.data.userId == request.auth.uid;
      allow read: if request.auth != null;
    }
  }
}

